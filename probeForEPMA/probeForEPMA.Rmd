---
title: "Probe For EPMA"
author: "John Minter"
date: "Started: 2017-05-27, Last modified: 2020-05-10"
output:
  html_document:
    css: ../theme/jm-gray-vignette.css
    number_sections: yes
    toc: yes
    toc_depth: 3
---
[Back to Index](../README.html)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Probe for EPMA is a commercial EPMA software package with demo packages,
especially CalcZAF. I have long term interest.

# Reproducible penepma simulations from the command line

As installed, the penempma GUI is convenient for testing problems. One issue
is that all the work is done in the folder

`C:\UserData\Penepma12\Penepma`

Note, this can be set to 

`C:\UserData\Penepma16\Penepma`

in

`C:\ProgramData\Probe Software\Probe for EPMA`


This is convenient, but I find it way too easy to overwrite data files. I prefer
to run the simulations in my own data directory where each folder has all
the files for/from the simulation. Each simulation has it's own batch file:
One file to rule them all :). On my Win10 box, my work directory is

`C:\Users\johnr\penepma_sims`

To make this work, I made a copy of `penepma.exe` from the
`C:\UserData\Penepma12\Penepma` folder, renamed it `penepma12.exe`
and put it in a folder (`C:\Apps\local\path`) in my path.


A simulation of a pure SiO2 bulk standard would start with the files:

```
bulk.geo (copied from the C:\UserData\Penepma12\Penepma folder)
SiO2-pure.mat (created from the GUI)
SiO2-pure.in (Created from the GUI)

and SiO2-pure.bat that contains the lines:

C:
cd "C:\Users\johnr\penepma_sims\SiO2-15kV"
echo "Running a 4 hr simulation of SiO2 at 15 kV"
Penepma12.exe < "SiO2-pure.in"
```

To run the simulation, I simply double-click the batch file and let 
it run. The program runs in the terminal...

At the conclusion of the run I compress a copy of folder with all the data files
to a 7zip archive. I then store the z-zip archive and copies of the most useful
files (e.g. SiO2.mat, SiO2.mat.bat, SiO2.mat.in, penepma.dat, peintens01.dat, 
and pe-spec-01.dat). I have `gnuplot` scripts to plot the intensity and spectra
files.

# John Donovan's note 2020-05-10

> Thank-you John.
>
> I should also mention that in order to calculate intensities down to 50 eV
> (necessary for Li ka), the number of secondaries generated are too large for
> the "forcing factor" arrays as specified by default in the Penepma GUI.
>
> For example, here are the default forcing factors generated by selecting the
> "Optimize Production of Characteristic X-rays" option (from the Cu_Cha.in file):

```
       >>>>>>>> Interaction forcing.
IFORCE 1 1 4 -10    0.1 1.0           [KB,KPAR,ICOL,FORCER,WLOW,WHIG]
IFORCE 1 1 5 -400   0.1 1.0           [KB,KPAR,ICOL,FORCER,WLOW,WHIG]

It's the FORCER factor in red (-400) that causes the problem, so if you intend to calculate characteristic spectra down to 50 eV or so you should edit this number to -200 as seen here:

       >>>>>>>> Interaction forcing.
IFORCE 1 1 4 -10    0.1 1.0           [KB,KPAR,ICOL,FORCER,WLOW,WHIG]
IFORCE 1 1 5 -200   0.1 1.0           [KB,KPAR,ICOL,FORCER,WLOW,WHIG]

```

> Just FYI,    
> john


# Using on a Mac Parallels VM

1. Before starting the Win 10 VM, use CMD+Option+D to hide the dock.

2. Start the Win 10 VM.

3. Use Full Screen mode in the Win 10 VM from the view menu
(or Shift-CMD-F). To exit FS mode, move the cursor to the **top left**
of the screen and hit the green button.

4. Run Standard and Configure and run PENEPMA.

5. When done with the VM, exit FS mode and shut down. Use CMD+Option+D
to restore the dock.

# Path to standard files

`C:\ProgramData\Probe Software\Probe for EPMA`

# Standard Databases

1. I renamed John Donovan's standard database to `jd-standard.mdb`

2. I added some compostions to John Donovan's base file (`standard.mdb`)


# Getting started

There is a good [Getting Started with CalcZAF](http://probesoftware.com/smf/index.php?topic=81.msg292#msg292)
by John Donovan on the Probe Software Forum.


**Getting help**: Access the the Probe for EPMA User Reference manual by
hitting the **F1** key in CalcZAF. **Note:** Win 10 does **not** support
the old style **.hlp** files. The easiest thing to do is to copy
**win32help.exe** from an old WinXP box to someplace in your path.
**Caution:** these .hlp files are not secure, so only use files from
sources you trust.

# Calculation options

Note the main CalcZAF screen layout below.

![The CalcZAF main screen. Note the four computation options in the
radio buttons near the body of the screen.](./img/MainScreenCalcZAF.png)

Note that one can write input files (.dat) for each of these modes.
Examples are shown below. Note that **each** of these assumes the
example is the **first entry** in the **.dat** file (hence the first 0).

## Key definitions

CalcZAF and Probe for EPMA use several versions of **k-factors**.
Happily, they provide some succinct definitions:

![Definitions for **k-factor** and **standard k-ratio**. Note that the latter is **ZAF corrected**!](./img/k-ratios.png)

![Raw k-ratios. This is what I normally associate with the term **k-ratio**.](./img/raw-k-ratio.png)

![Note that the **unknown k-ratio** is also ZAF-corrected](./img/unknown-k-ratio.png)

and finally...

![ZAF that puts it all together...](./img/ZAF.png)

## Working with Standards

Probe for EPMA maintains a standard database that is very convenient to
use when the standards have been set up. I found setting them up a bit 
confusing at first. CalcZAF makes use of these for the computations and
it reduces repetitive input.

To work with standards, one uses **both** the 
**CalcZAF.exe** program and the **Standard.exe** program.

We'll start with the **New** function...

![Choose the **New** option](./img/standard-standard-menu.png)

See the example below.


### Creating and modifying standards

In one of our labs in the Lehigh Quantitative Microanalysis course we
wanted to create three standards for Ir~X~Si~Y~ inter-metallic compounds
and to use one that had been verified by wet chemistry as a standard to
analyze an unknown to see if we could properly identify the unknown.

In this case, we will set up the standard for the **Ir~3~Si~5~**
inter-metallic that will be used as a standard in our computations.

We create the standard from the **Standard.exe** program. When we start
that program we need to choose a standard file. In this case we use the
default, **standard.mdb**. The top menu bar has a **Standard** button
that displays the following menu. 

This presents a dialog box that we can fill in. The figure below shows a
complete box. Under the bottom of the red arrow is what the blank fields
looks like. **Note:**  Compositions are in **weight percent** not weight
fractions.

![Choose the **New** option. The sample number was chosen to match that assigned by Paul Carpenter. ](./img/Ir3S5-complete.png)

When one clicks the mouse button on a **blank element field** a dialog
appears to set up the standard parameters for that element. The Ir field
is shown below.

![The Ir element dialog. Choose the element and line from the boxes and add the weight fraction. One could choose a crystal for the probe.  For these calculations we can ignore this.](./img/Ir3S5-ep-box.png)

We repeat the process for Si and then I computed an estimate of the
density that was in the completed dialog above.

Standard numbering is systematic for Probe for EPMA. For our use with
CalcZAF we can assign non-assigned numbers. I'll figure out the
convention later...

**We repeat the process for all our standards for the run**.


### Using standards in a computation

To use standards in a computation, we have to use the **Standard** menu
from **CalcZAF** to **Add Standards To/From Run**.

![**CalcZAF** Add standards to/from run menu.](./img/calczaf-add-stds-to-run.png)

So we can set up our analysis of our unknown as follows:

First add the information for the unknown for **both** Ir and Si and
assign the standard:

![Assign the standard to both samples](./img/unknown-both-stds.png)

![Now we are ready to calculate...](./img/unknown-ready-to-calculate.png)

Before we run the model, let's look at the results using elemental
standards...

```
CalcZAF Sample () at 40 degrees and 20 keV

STANDARD PARAMETERS (TOA= 40):

 ELEMENT  STDNUM STDCONC STDKFAC   Z-BAR  ABSCOR  FLUCOR  ZEDCOR  ZAFCOR                  
   Ir La     577  99.700   .9956 76.7930   .9997   .9999  1.0019  1.0014
   Si Ka     514 100.000  1.0000 14.0000  1.0000  1.0000  1.0000  1.0000

 ELEMENT STP-POW BKS-COR   F(x)e   F(x)s      Eo      Ec   Eo/Ec
   Ir La  1.0030   .9989   .9459   .9462   20.00 11.2150  1.7833
   Si Ka  1.0000  1.0000   .8503   .8503   20.00  1.8390 10.8755

SAMPLE: 0, TOA: 40, ITERATIONS: 3, Z-BAR: 67.79354

 ELEMENT  ABSCOR  FLUCOR  ZEDCOR  ZAFCOR STP-POW BKS-COR   F(x)u      Ec   Eo/Ec    MACs uZAF/sZAF
   Ir la   .9910   .9999  1.0789  1.0691  1.1233   .9604   .9545 11.2150  1.7833 122.499  1.067533
   Si ka  1.5826   .9907   .7777  1.2193   .5790  1.3433   .5373  1.8390 10.8755 1295.53  1.219305

 ELEMENT   K-RAW K-VALUE ELEMWT% OXIDWT% ATOMIC% FORMULA KILOVOL                                        
   Ir la  .78920  .78570  83.997   -----  46.058   3.685   20.00                        
   Si ka  .11790  .11790  14.376   -----  53.942   4.315   20.00                        
   TOTAL:                 98.373   ----- 100.000   8.000


```

And we get....

```
CalcZAF Sample () at 40 degrees and 20 keV

STANDARD PARAMETERS (TOA= 40):

 ELEMENT  STDNUM STDCONC STDKFAC   Z-BAR  ABSCOR  FLUCOR  ZEDCOR  ZAFCOR                  
   Ir La    2843  80.415   .7355 64.6615   .9884   .9999  1.1062  1.0933
   Si Ka    2843  19.585   .1628 64.6615  1.5380   .9914   .7892  1.2033

 ELEMENT STP-POW BKS-COR   F(x)e   F(x)s      Eo      Ec   Eo/Ec
   Ir La  1.1660   .9487   .9459   .9570   20.00 11.2150  1.7833
   Si Ka   .6025  1.3099   .8503   .5529   20.00  1.8390 10.8755

SAMPLE: 0, TOA: 40, ITERATIONS: 3, Z-BAR: 67.28297

 ELEMENT  ABSCOR  FLUCOR  ZEDCOR  ZAFCOR STP-POW BKS-COR   F(x)u      Ec   Eo/Ec    MACs uZAF/sZAF
   Ir la   .9905   .9999  1.0833  1.0730  1.1303   .9585   .9549 11.2150  1.7833 123.777  .9814445
   Si ka  1.5752   .9908   .7796  1.2166   .5828  1.3377   .5398  1.8390 10.8755 1308.24  1.011044

 ELEMENT   K-RAW K-VALUE ELEMWT% OXIDWT% ATOMIC% FORMULA KILOVOL                                        
   Ir la 1.07200  .78850  84.605   -----  44.484   3.559   20.00                        
   Si ka  .77920  .12682  15.429   -----  55.516   4.441   20.00                        
   TOTAL:                100.034   ----- 100.000   8.000

```

The totals has improved.... I don't remember f(&Chi;) being that bad...

And we can test the effect of models

![The effect of calculating all matrix corrections](./img/effect-of-models.png)


## Basic Input - Pseudo Code example

First some hints:

Note 1:

```
CalcMode% = 0 for calculation of k-ratios from concentrations
CalcMode% = 1 for calculation of concentrations from unknown and standard intensities
CalcMode% = 2 for calculation of concentrations from "raw" k-ratios (no standard intensities necessary)
CalcMode% = 3 for calculation of concentrations from "normalized" k-ratios (no standards necessary)
```

Note 2:

```
OxideorElemental%=1 calculate oxide output based on stoichiometry
OxideorElemental%=2 calculate as elemental output (default)
```



**Note 3:** all strings (element symbols, etc.) must be in double
quotes, elements not analyzed (specified concentrations or calculated)
are indicated by a blank (empty double quotes) x-ray line string. If
the element is a specified concentration, be sure to give the
concentration in elemental weight percent for the
`"ElmPercents!(I%)"` parameter and leave the count intensity
fields zero.


**Now the pseudo code...**

```
' Read calculation mode (0, 1, 2, or 3), number of elements, 
' kilovolts and takeoff, (optional sample name)
Input #3, CalcMode%, LastChan%, Kilovolts!, Takeoff!, (SampleName$)


' Read oxide/elemental mode, difference, stoichiometry, relative
Input #3, OxideOrElemental%, DifferenceElement$, StoichiometryElement$,  StoichiometryRatio!, RelativeElement$, RelativeToElement$, RelativeRatio!


' Loop on each element
For i% = 1 To LastChan%
   Input #3, Elsyms$(i%), Xrsyms$(i%), NumCat%(i%), NumOxd%(i%), StdAssigns%(i%), ElmPercents!(i%), UnkCounts!(i%), StdCounts!(i%)
next i%

```


**Now the examples...**

## Mode 0 - Calc Intensities from weight concentrations

```
0,2,15,40.,”MgO K-ratio""

2,"","",0.0,"","",0.0

"mg","ka",1,1,0,60.0,0.0,0.0

"o","ka",1,0,0,40.0,0.0,0.0
```

## Mode 1 - (calculates concentrations from unk and std intensities)

```
0,3,15,40.,”Fe2SiO4”

2,"","",0.0,"","",0.0

"fe","ka",1,1,895,0.0,7568.1,10265.7

"si","ka",1,2,14,0.0,1329.4,5268.2

"o","ka",1,0,895,0.0,2519.6,2498.1
```

## Mode 2 - Calculates concentrations from "raw" k-ratios

```
0,3,15,40.,”Fe2SiO4”

2,"","",0.0,"","",0.0

"fe","ka",1,1,895,0.0,.96283,0.

"si","ka",1,2,914,0.0,.00003,0.

"o","ka",1,0,895,0.0,1.09972,0.

```

This is what the results look like:

I need a clear summary of the difference between **standard k-factors** and
**k-raw**.

![Mode 2](./img/example-2-ana.png)

# Mode 3 - calculates concentrations from normalized k-ratios

```
0,2,20,40.,”MgO”

2,"","",0.0,"","",0.0

"mg","ka",1,1,0,0.,.418853,0.0

"o","ka",1,0,0,0.,.190763,0.0
```

# PENEPMA Monte Carlo Simulations

## General Instructions


### Helpful voltages for penepma12/16 simulations

For thin films on substrates, the following series of keVs are helpful

[5, 10, 15, 20, 25 keV]

For light elements Like B or ZnO L lines where the ZnLa1 line is
1.0116 keV and the O Ka1 and Ka2 lines are at 0.5249 keV, one 
can use:

[2, 5, 7, 10 keV]

The DTSA2 command line function `listTransitions("Zn")` is
very helpful in picking the most reasonable beam energies...

### Simulation Times

| hrs for sim | seconds |
|------------:|--------:|
| 1 | 3600 |
| 2 | 7200 |
| 4 | 14440 |
| 8 | 28800 |
| 24 | 86400 |
| 27.8 | 10^5^ (default) |



### Some hints on effective simulations

1. You can create a multi-layer simulation from the GUI and create a `simulation.in` file. These can be imported with the `Browse` button and edited.

2. One can use the `Edit Input File` to manually edit the input.

3. I like to set a **low minimum photon energy** : I like `1.0e+2` (100 eV).

4. I like the S/N ratio of the data with a 12 hr (43200 sec) simulation.

5. Both penepma12 and penepma16 use a single core. One can run two simulations at
one time by adjusting the window positions.

### Use of a random seed

John Donovan explained the use of the random seed in `penepma`
in this [post](https://probesoftware.com/smf/index.php?topic=202.msg8305#msg8305)
on the Probe Software Forum:

> This question came up off-line so I thought I would mention it here.
> 
> When running Penepma from the GUI in the Standard application, the random
> seed is *not* varied. This is for reproducibility of results.
>
> However when running Penepma from **Probe for EPMA** to simulate EDS spectra,
> the random seed *_is_* varied.
>
> To add a random seed in the Penepma input file simply add a line like this to
> your .in file:
>
> ```
> RSEED  1 2                  [Seeds of the random-number generator]
> ```
>
> The defaults are 1 and 2 so you should change them if you want to simulate
> random statistics, though the Penepma documentation does not explain exactly
> **how** they are utilized that I can find. Except for this bit of code:
>
> ```
> C *********************************************************************
> C FUNCTION RAND
> C *********************************************************************
> FUNCTION RAND(DUMMY)
> C
> C This is an adapted version of subroutine RANECU written by F. James C
> C (Comput. Phys. Commun. 60 (1990) 329-344), which has been modified to
> C give a single random number at each call.
> C
> C The 'seeds' ISEED1 and ISEED2 must be initialised in the main program
> C and transferred through the named common block /RSEED/.
> C
> 
> IMPLICIT DOUBLE PRECISION (A-H,O-Z), INTEGER*4 (I-N)
> PARAMETER (USCALE=1.0D0/2.147483563D9)
> COMMON/RSEED/ISEED1,ISEED2
> C
> I1=ISEED1/53668
> ISEED1=40014*(ISEED1-I1*53668)-I1*12211
> IF(ISEED1.LT.0) ISEED1=ISEED1+2147483563
> C
> I2=ISEED2/52774
> ISEED2=40692*(ISEED2-I2*52774)-I2*3791
> IF(ISEED2.LT.0) ISEED2=ISEED2+2147483399
> C
> IZ=ISEED1-ISEED2
> IF(IZ.LT.1) IZ=IZ+2147483562
> RAND=IZ*USCALE
> C
> RETURN
> END
> ```
>
> and the following text:
>
> > 1.2.1 Random-number generator
> > In general, random-sampling algorithms are based on the use of random numbers » uniformly distributed in the interval (0,1). These random numbers can be easily generated on the computer (see, e.g., Kalos and Whitlock, 1986; James, 1990). Among the \good" random-number generators currently available, the simplest ones are the so-called multiplicative congruential generators (Press and Teukolsky, 1992). A popular example of this kind of generator is the following,
> > 
> > Rn = 75Rn¡1 (mod 231 ¡ 1); »n = Rn=(231 ¡ 1); (1.30)
> > 
> > which produces a sequence of random numbers »n uniformly distributed in (0,1) from a given \seed" R0 (< 231 ¡ 1). Actually, the generated sequence is not truly random, because it is obtained from a deterministic algorithm (the term \pseudo-random" would be more appropriate), but it is very unlikely that the subtle correlations between the values in the sequence have an appreciable e®etc on the simulation results. The generator (1.30) is known to have good random properties (Press and Teukolsky, 1992). 
> > 
> > However, the sequence is periodic, with a period of the order of 109. With present-day computational facilities, this value is not large enough to prevent re-initiation in a single simulation run. An excellent critical review of random-number generators has been published by James (1990), where he recommends using algorithms that are more sophisticated than simple congruential ones. The generator implemented in the Fortran 77 function RAND (Table 1.1) is due to L'Ecuyer (1988); it produces 32-bit floating-point numbers uniformly distributed in the open interval between zero and one. Its period is of the order of 1018, which is virtually inexhaustible in practical simulations.


## Instructions for penepma12 from default Standard.exe

Note that one starts Monte Carlo simulations from the **Standards.exe** window

![Starting Monte Carlo Simulations](./img/start-mc.png)

The image below shows how to run a basic simulation using **penepma12**. There is
now (2020-02-13) a way to run penepma16 from the GUI as well.

![The basic procedure to run a simulation. It really is as easy as 1, 2, 3, 4, 5...](./img/penepma-input.png)

1. Create an input file. One may do it three ways:

- Select a material from the standards list (this example)

- Create a material from a chemical formula

- create a material from weight fractions

2. Select a geometry and your input parameters and then
**create the PENEPMA Input file**.


Note the default input parameters:

![**Note the large number of default trajectories (2.0e9) and the long simulation time (1.0e5 sec = 27.8 hrs!)** You probably want to change these to something like **2.0e4 trajectories** and **3600 sec (1 hr)** or **28800 sec (8 hrs) **. You probably also want to **set the minimum photon energy to 90 eV**. Do this **before!!** you press **Create PENEPMA input file.** or edit the file and restart the GUI before starting the simulation...](./img/penepma-default-input-par.png)

- Enter simulation time values on the last line of the **name.in** file for the simulation.
- Enter the energy ranges are on the `MSIMPA` lines of the **name.in** file for the simulation.


| hrs for sim | seconds |
|------------:|--------:|
| 1 | 3600 |
| 2 | 7200 |
| 4 | 14440 |
| 8 | 28800 |
| 24 | 86400 |
| 27.8 | 10^5^ (default) |


Note it has a **.in** extension. Note that this is a text file that is well
commented.


```
TITLE  Characteristic X-ray Production Model
       .
       >>>>>>>> Electron beam definition.
SENERG 1.50E+04                  [Energy of the electron beam, in eV]
SPOSIT 0 0 1                     [Coordinates of the electron source]
SDIREC 180 0              [Direction angles of the beam axis, in deg]
SAPERT 0                                      [Beam aperture, in deg]
       .
       >>>>>>>> Material data and simulation parameters.
MFNAME Corning 'X' glas.MAT           [Material file, up to 20 chars]
MSIMPA 9.0E+1 9.0E+1 1E+3 0.1 0.1 1E+3 1E+3 [EABS(1:3),C1,C2,WCC,WCR]
       .
       >>>>>>>> Geometry of the sample.
GEOMFN bulk.geo                  [Geometry definition file, 20 chars]
DSMAX  1 1.5e-2             [IB, Maximum step length (cm) in body IB]
       .
       >>>>>>>> Interaction forcing.
IFORCE 1 1 4 -10    0.1 1.0           [KB,KPAR,ICOL,FORCER,WLOW,WHIG]
IFORCE 1 1 5 -400   0.1 1.0           [KB,KPAR,ICOL,FORCER,WLOW,WHIG]
       .
       >>>>>>>> Photon detectors (up to 10 different detectors).
PDANGL 50.0 60.0 0.0 360.0 0           [Angular window, in deg, IPSF]
PDENER .0 20e+03 1000                [Energy window, no. of channels]
       .
       >>>>>>>> Job properties
RESUME dump1.dat               [Resume from this dump file, 20 chars]
DUMPTO dump1.dat                  [Generate this dump file, 20 chars]
DUMPP  120                                   [Dumping period, in sec]
       .
NSIMSH 2.0e+04                  [Desired number of simulated showers]
RSEED  1 1                     [Seeds of the random-number generator]
TIME   3600                        [Allotted simulation time, in sec]
```

3. Run the file.  Wait - it gives progress reports. For a single
run the program automatically plots the spectrum. This outputs
the **.mat** file which is a text result file.

4. You will typically want to select a log scale. You can then 
copy to the clipboard. I check this with ImageJ. **It would be
really cool to output the file in .msa format.**

And this is what I obtained. Note that if one wanted to compute K-ratios
from spectra, it might be worth computing more trajectories... It would
also be nice to be able to export these to **.msa** spectrum files to
plot in DTSA-II with markers and make publication quality graphics with
gnuplot... I think Probe for EPMA uses Surfer... 

![Output from our example simulation from Corning X glass with 20,000 trajectories](./img/penepma-output.png)

And this is the output after an hour on the VM on my MacBook

![Output from our example simulation from Corning X glass after 1 hr on my MacBook VM (3.38e5 trajectories)](./img/penepma-output-1hr.png)

Note that the spectrum was output in

```
C:\UserData\Penepma12\Penepma\pe-spect-01.dat
```

The columns are:

```
 #  Whole spectrum. Characteristic peaks and background.
 #  1st column: photon energy (eV).
 #  2nd column: probability density (1/(eV*sr*electron)).
 #  3rd column: statistical uncertainty (3 sigma).

```

I'm not certain how to convert to a peak intensity...

There is the **pe-intens-01.dat** file that has the intensity of the characteristic lines... Think I'd get k-ratios from that... 

## Bilayer simulations

Note [this](http://probesoftware.com/smf/index.php?topic=57.0) thread on the Probe software forum. Seems there was a bug...

John Donovan suggests that the finished product should look like this:

![John Donovan's example thin film simulation](./img/Penepma-Thin-film-MC.png)

And my implementation...

![My simulation of a thin film of N-doped ZnO on Si](./img/JRM-penepma-thin-film-mc.png)

# Running penepma 16 from the GUI

## Compiling penepma16 from source.

On Windows 10, I use the Fortran compiler that comes with RTools

**Fix the number of channels**

One needs to set the number of channels to to 4096

**My compile script** is: [here](penepma16/compile.bat).

**The Fortran file ** - modified for 4096 channels - is [here](penepma16/penepma.f).

## Example penepma16 simulations with 4096 channels

**Note**: These zip files include all required input and gnuplot files
to plot the resulting spectra.

**An example bulk Si simulation** - modified for 4096 channels - is [here](penepma16/Si_20kV.zip).

**An example bulk Cu simulation** - modified for 4096 channels - is [here](penepma16/Cu_20kV.zip).

**An example 100 nm Cu film on Si  simulation** - modified for 4096 channels - is [here](penepma16/100_nm_Cu_on_Si_20kV.zip).

# Plotting $\phi \rho z$ curves. 

This feature was added in May 2018. A nice example is
[here](http://probesoftware.com/smf/index.php?topic=1070.msg7144#msg7144).
Brian Joy implemented the computations for XPP and PAP models.

1. Start by using the Analytical menu to get to a dialog that permits
setting the desired $\phi \rho z$ model.
![](./img/prz-plot-1-select-prz-corr.png)

2. Choose the ZAF Phi-Rho-Z button to get to the next menu.
![](./img/prz-plot-2-select-prz-options.png)
3. Choose the desired method. In this case PAP. Select `OK` to return.
![](./img/prz-plot-3-select-prz-method.png)


4. Use the Calculation Options button to set the `Calculation Options`
and the `Enter Composition` button to enter our compound (`al2o3`)
![](./img/prz-plot-4-menus.png)

5. Then use the `Calculation Options` to set the density  to 3.95
for our Al~2~O~3~ example.
![](./img/prz-plot-5-set-density.png)

6. Our final pane should look like this. We then press the `calculate` button.
![](./img/prz-plot-6-ready.png)

7. The result window contains a plot.Note the option to `Export Data`
(as a tab-delimited file) and the ability to switch between $Z$ and $\rho Z$
display modes.
![](./img/prz-plot-7-results.png)


# System Administration

These are tips for use and sys-admin.


## Key directories in my install

1. Preferred install dir

```
C:\Apps\CalcZAF
```

This has programs and some data

2. Windows ProgramData

```
C:\ProgramData\Probe Software\Probe for EPMA 
```

**standard.mdb** goes in here, as do update installers. John Donovan
occasionally updates this file.

3. User data

```
C:\UserData
```

Has the following tree with data files

![UserData tree](./img/UserData-tree.png)
 

4. UserImages
 
This would have images from the system
 
```
C:\UserImages
```

Currently empty in my installs

# Some wisdom on sample mounts from Probeman

He writes **2020-01-07**:

I wanted to update this topic with some actual photos of the mount because the best aspect of these acrylic mounts (see above post and login to see the attachment!) is that they are super easy to re-polish.

I'm sure most of us have had to deal with standard mounts where each standard material is individually mounted in a brass sleeve and then inserted in a multi-hole brass mount with a set screw for each standard. But this method requires that the brass sleeves and mount be completely disassembled and then each standard "tube" has to be polished separately. Then ultra-sonically cleaned because the epoxy tends to pull away from the inside of the brass sleeve when it originally was cured, resulting in a tiny gap that can collect polishing compounds and oils/solvents.

With these acrylic mounts seen here:

![Example acrylic mount](img/mount_1.jpeg)

the epoxy completely adheres to the acrylic hole and when the mount is cured, the *entire* mount shrinks by a small amount. But no gaps or cracks!

So to clean these acrylic mounts one merely uses a little 0.05 um colloidial alumina (or silica) on a soft lap and polishes off the carbon (and any oxide buildup and/or beam damage), then just a quick rinse in ethanol (only use pure ethanol to avoid damaging the epoxy!), and then wipe clean with a KimWipe, and dry in a warming oven for a few minutes immediately prior to carbon coating.

This type of acrylic block makes it so easy to re-polish ones standards that you won't hesitate to do it when it needs to be done!  And if you look closely at the above photo you can see the carefully scribed vertices of a triangle which contain our three "fiducial" marks for quickly re-calibrating our digitized standard positions when the mount is replaced within the sample holder.

Another standard mounting method which we don't use, but which I have an example of, is similar to the acrylic mounting method, but the epoxy is filled with copper shavings and it has a metal outer sleeve. This mount was labeled the "MAC" mount (when I first arrived in Oregon) and I suspect it came with a very old microprobe many decades ago:

![Older mount with epoxy and Cu shavings](img/mount_2.jpeg)

However, for whatever reason , our lab manager Julie Chouinard had to vacuum re-impregnate it with epoxy because we did have some tiny cracks in a few places.  Now however, it works great for a quick re-polish.



## Fix a Win 7 problem

From [here](https://probesoftware.com/smf/index.php?topic=76.msg2289#msg2289)

We now have a fix for the Windows Installer issues that I have been seeing on some Win7 64 computers. The steps are amazingly easy, so here they are, but do let me know if you have trouble with them.

1. Open the command prompt in administrator mode by typing "cmd" in the Start button "Search Programs and Files field, then once the Cmd.exe app appears in the file list, right click the Cmd.exe app and select "Run As Administrator" from the menu. 

2. Then navigate to `C:\Windows\System32` folder using the DOS cd command and type following command line:

```
regsvr32 msi.dll
```

3. Now, navigate to `C:\Windows\SysWow64` folder and again type same command line:

```
regsvr32 msi.dll
```

That fixed all the Windows installer and update issues on all the computers I've tried it on so far.



[Back to Index](../README.html)